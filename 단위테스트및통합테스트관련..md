관련 애너테이션
오직 Controller에 대해서만 테스트 검증을 할 때는 @WebMvcTest 를 사용하면 됨.


@Service, @Repository 등도 같이 사용해야하는 로직이라면 어떻게 해야할까? 그리고 JPA도 사용해야한다면?

@SpringBootTest 어노테이션을 사용해야 한다. 하지만 이 어노테이션만 가지고는 MockMvc를 사용할 수 없다. 
따라서 어노테이션이 하나 더 필요하다. -> @AutoConfigureMockMvc

@AutoConfigureMockMvc

- @WebMvcTest와 가장 큰 차이점은은 컨트롤러뿐만 아니라 테스트 대상이 아닌 @Service나 @Repository가 붙은 객체들도 모두 메모리에 올린다는 것이다.

- @SpringBootTest에는 웹 애플리케이션 테스트를 지원하는 webEnvironment 속성이 있다. 이 속성을 생략하면 기본값으로 WebEnvironment.MOCK이 설정되어 있는데, 이 설정에 의해서 서블릿 컨테이너가 모킹된다.
 
 
 Mock 객체
- Mock이라는 단어를 사전에서 찾아보면 '테스트를 위해 만든 모형'을 의미한다.

- 테스트를 위해 실제 객체와 비슷한 모의 객체를 만드는 것을 모킹(Mocking)이라고 하며, 모킹한 객체를 메모리에서 얻어내는 과정을 목업(Mock-up)이라고 한다.

- 객체를 테스트하기 위해서는 당연히 테스트 대상 객체가 메모리에 있어야 한다.하지만 생성하는 데 복잡한 절차가 필요하거나 많은 시간이 소요되는 객체는 자주 테스트하기 어렵다. 또는 웹 애플리케이션의 컨트롤러처럼 WAS나 다른 소프트웨어의 도움이 반드시 필요한 객체도 있을 수 있다. 이런 복잡한 객체는 당연히 테스트 과정도 복잡하고 어려울 수 밖에 없다.

- 따라서 테스트 하려는 실제 객체와 비슷한 가짜 객체를 만들어서 테스트에 필요한 기능만 가지도록 모킹을 하면 테스트가 쉬워진다.
- 테스트하려는 객체가 복잡한 의존성을 가지고 있을 때, 모킹한 객체를 이용하면, 의존성을 단절시킬 수 있어서 쉽게 테스트할 수 있다.
- 웹 애플리케이션에서 컨트롤러를 테스트할 때, 서블릿 컨테이너를 모킹하기 위해서는 @WebMvcTest를 사용하거나 @AutoConfigureMockMvc를 사용하면 된다.

- 웹 환경에서 컨트롤러를 테스트하려면 반드시 서블릿 컨테이너가 구동되고 DispatcherServlet 객체가 메모리에 올라가야 하지만, 서블릿 컨테이너를 모킹하면 실제 서블릿 컨테이너가 아닌 테스트용 모형 컨테이너를 사용하기 때문에 간단하게 컨트롤러를 테스트할 수 있다.


@SpringBootTest의 기능

기본 ContextLoader로써 SpringBootContextLoader를 사용한다.
자동으로 @SpringBootConfiguration을 찾는다. @SpringBootConfiguration은 @SpringBootApplication(메인 클래스) 안에 있다.
커스텀 Environment 프로퍼티를 정의할 수 있다.
어플리케이션 구동 시 설정하는 application argument를 테스트 프로그램에서 정의할 수 있다.@SpringBootTest(args="--app.test=one")
WebEnvironment를 지정할 수 있다.

WebEnvironment.MOCK : 아무런 설정이 없을 시 적용되는 디폴트 설정이다. mock 서블릿 환경으로 내장톰캣이 구동되지 않는다.(브라우저에서 접속되지 않는다.)
WebEnvironment.RANDOM_PORT : 스프링부트를 직접 구동시킨 것처럼 내장톰캣이 구동되나 랜덤포트로 구동된다.
WebEnvironment.DEFINED_PORT : 정의된 포트로 내장톰캣이 구동된다.
WebEnvironment.NONE : WebApplicationType.NONE으로 구동된다.


테스트를 위한 TestRestTemplate 빈과 WebTestClient 빈을 등록할 수 있다.만일 WebEnvironment.MOCK 이라면 TestRestTemplate과 WebTestClient빈은 등록되지 않는다. 실제 내장톰캣이 구동되지 않으므로 사용할 여지가 없고 어플리케이션에 요청을 보내고 싶다면 MockMvc로 테스트하면 되기 때문이다.

WebEnvironment 설정에서 디폴트 값이 MOCK 이므로 내장톰캣이 구동되지 않고 테스트가 수행되는 것에 유의한다.

@AutoConfigureMockMvc
디폴트 설정이 서버가 실행되지 않고 Mock 환경에서 진행되므로 컨트롤러처럼 엔드포인트가 있는 테스트를 진행할 때는 MockMvc를 활용한다.MockMvc는 가상의 클라이언트로 어플리케이션에 요청을 날리는 역할을 한다. MockMvc를 생성하는 방법에는 여러 가지 있지만 테스트클래스에 @AutoConfigureMockMvc을 마킹하고 주입받는 것이 간단하다.
MockMvc를 사용하여 mock 환경에서 컨트롤러를 테스트하는 코드이다.
출처: https://yangbox.tistory.com/36 [양's World:티스토리]

 